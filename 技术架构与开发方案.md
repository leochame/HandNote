# 个人倒班手账 APP - 技术架构与开发方案总览

## 一、业务闭环与系统总览

本项目为一个**纯本地、零后端**的 Android 原生效率手账应用。系统以"时间调度"为核心，以"内容沉淀"为终点，整体业务闭环如下：

### 业务流程

1. **规则与事件定义**：用户可配置复杂的周期性排班规则（支持排除法定节假日），以及按年循环的纪念日/特殊事件，并为它们分配不同的提醒等级（强闹钟 vs 弱通知）。

2. **实例生成**：系统引擎在后台根据排班算法和纪念日配置，统一生成当天的具体待办实例（Task 实例）。

3. **分级调度触达**：到达指定时间戳，引擎根据任务的"提醒等级"，触发对应的触达方式（全屏强力闹钟 或 系统标准横幅通知）。

4. **动作路由**：用户响应提醒，系统通过 Deep Link 唤起本机目标 App（如打卡、背单词软件）执行操作。

5. **内容沉淀**：用户事后在应用内撰写图文手账，系统自动关联当日已完成的 Task 或 纪念日，形成"执行-记录"的完整信息流。

---

## 二、核心技术栈与架构模式

### 开发语言
- **Kotlin**

### 架构模式
- **MVVM** (Model-View-ViewModel) + Repository 模式
- 配合 **Kotlin Flow** 实现 UDF (单向数据流)

### UI 框架
- **Jetpack Compose** (声明式 UI，适合快速构建日历与复杂信息流)

### 本地数据库
- **Room** (SQLite 官方 ORM，结合 Coroutines/Flow 实现响应式数据流)

### 异步与调度
- **Kotlin Coroutines** (协程)
- **Android AlarmManager**

### 网络通信
- **OkHttp** + **Retrofit** (仅用于拉取 Serverless 静态配置)

---

## 三、核心开发方案详解

### 3.1 分级提醒引擎与防杀后台机制 (核心难点)

为了区分"倒班打卡"和"节假日/纪念日"，系统设计了分级提醒机制。所有定时任务统一交由 AlarmManager 触发，但在 BroadcastReceiver 接收到广播后，根据 `reminder_level` 走不同的呈现逻辑：

#### Level 2 - 强提醒闹钟
**适用于**：倒班任务、核心打卡

**调度核心**：
- 使用 `AlarmManager.setAlarmClock()` 注册最高优先级闹钟，必定击穿 Doze 休眠模式。

**触发链路**：
1. 广播接收后
2. 启动 **Foreground Service** (前台服务) 持续播放自定义长音频与震动
3. 触发 **Full-Screen Intent** (全屏通知意图，锁屏状态下强制亮屏并弹出交互页面)

#### Level 1 - 普通系统通知
**适用于**：纪念日、节假日提醒、弱提醒任务

**调度核心**：
- 使用 `AlarmManager.setExactAndAllowWhileIdle()` 注册精准定时器。

**触发链路**：
1. 广播接收后
2. 构建标准的 `NotificationCompat.Builder`
3. 通过 `NotificationManager.notify()` 发出一条带声音的系统横幅通知（不启动前台服务，不强制全屏抢占）

#### Level 0 - 无提醒仅标记
**适用于**：无需打扰的备忘

**调度核心**：
- 不注册 AlarmManager。仅在首页日历视图 (CalendarView) 中作为 UI 数据节点进行红点/图标渲染。

---

### 3.2 动态排班算法与任务引擎

基于"周期与偏移量"的模运算算法，解决复杂排班（如三班倒、做二休一）问题。

#### 算法公式
```
DayIndex = (CurrentDate - StartDate) % CycleDays
```

#### 执行逻辑

1. **监听系统事件**：
   - `ACTION_BOOT_COMPLETED` (开机广播)
   - `ACTION_TIME_CHANGED` (时区改变)

2. **任务生成流程**：
   - APP 每次冷启动或每日凌晨，计算未来 24-48 小时的 DayIndex
   - 查表比对该 DayIndex 对应的排班配置 JSON
   - 同时查询 Anniversary (纪念日表) 当天是否有特殊事件
   - 结合"节假日表"判断是否跳过
   - 将排班和纪念日统一转化为 TaskRecord 实例
   - 按需向 AlarmManager 注册分级提醒

---

### 3.3 第三方应用探针与路由映射

#### 获取白名单
通过 `PackageManager.getInstalledPackages(0)` 获取本机应用列表，供用户选择绑定。
- 需在 Manifest 声明 `QUERY_ALL_PACKAGES` 权限

#### 路由执行
闹钟/通知被点击响应后，读取 Task 绑定的 `packageName`，通过以下核心代码唤起：

```kotlin
fun launchTargetApp(context: Context, packageName: String) {
    val launchIntent = context.packageManager.getLaunchIntentForPackage(packageName)
    if (launchIntent != null) {
        launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
        context.startActivity(launchIntent)
    } else {
        // 异常兜底：应用被卸载，跳转应用市场或 Toast 提示
    }
}
```

---

### 3.4 零后端 (Serverless) 节假日数据同步

#### 数据托管
在 GitHub Pages / Gitee Pages 上部署一个公开的 `holidays_{year}.json` 静态文件。

#### 静默同步
- APP 内置定时检查逻辑（如每月 1 号）
- 使用 OkHttp 后台拉取该 JSON

#### 数据融合
- 解析 JSON 后 Upsert 存入本地 Room 的 Holiday 表
- 排班引擎在生成闹钟前，优先查询该表拦截法定节假日

---

## 四、本地数据模型 (Room DB 设计)

整个应用的底层由 5 张核心表（Entity）支撑：

### ShiftRule (排班规则表)

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | Long | PK，主键 |
| `title` | String | 规则名称 |
| `start_date` | Long | 基准时间戳 |
| `cycle_days` | Int | 周期长度 |
| `shift_config` | String | JSON 数组，包含每天的时间点、关联包名 |
| `skip_holiday` | Boolean | 是否智能跳过节假日 |
| `default_reminder_level` | Int | 默认提醒等级：通常为 2-强闹钟 |

### Anniversary (纪念日/特殊事件表)

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | Long | PK，主键 |
| `title` | String | 事件名称，如"结婚纪念日"、"交租日" |
| `target_date` | String | 日期，格式 MM-DD，考虑后期可扩展农历 |
| `reminder_level` | Int | 提醒等级：通常为 1-普通通知，或 0-仅日历显示 |
| `reminder_time` | String | 通知触发的当天具体时间，如 "09:00" |

### TaskRecord (每日任务实例表 - 统一调度池)

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | Long | PK，主键 |
| `source_type` | Int | 0: 倒班规则生成, 1: 纪念日生成, 2: 临时单次任务 |
| `source_id` | Long | 关联的 Rule ID 或 Anniversary ID |
| `target_date` | String | 归属日期，格式 YYYY-MM-DD |
| `trigger_timestamp` | Long | 精确触发时间戳 |
| `reminder_level` | Int | 当前任务的提醒等级：0, 1, 2 |
| `status` | Int | 0:待执行, 1:已完成打卡, 2:已过期/跳过 |
| `target_pkg_name` | String | 绑定的目标跳转包名，可为空 |

### Post (手账/帖子表)

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | Long | PK，主键 |
| `create_time` | Long | 创建时间 |
| `content` | String | 长文本 |
| `image_paths` | String | 本地存储的绝对路径列表，JSON格式 |
| `linked_task_ids` | String | 关联的 Task ID 列表，用于信息流展示闭环 |

### Holiday (节假日缓存表)

| 字段 | 类型 | 说明 |
|------|------|------|
| `date` | String | PK，格式 YYYY-MM-DD |
| `type` | Int | 0: 工作日调休, 1: 法定休息日 |
| `name` | String | 节日名称 |

---

## 五、UI 视图层架构 (Compose Navigation)

### Tab 1 - CalendarView (日程日历)

- **自定义日历组件** (基于 `LazyVerticalGrid`)
- **分级视觉渲染**：通过查询 TaskRecord 的 `source_type` 和 `reminder_level`，在日历格子上打上不同的角标
  - 实心红点：代表强闹钟倒班
  - 空心蓝点/星星：代表纪念日/弱提醒
- **底部联动展示**：选中日期的完整时间轴

### Tab 2 - FeedView (信息流沉淀)

- 使用 `LazyColumn` 实现无限滚动列表
- **联合查询** Post 与 TaskRecord，将手账图文与带有 ✓ 标记的任务/纪念日卡片组合渲染

### Tab 3 - Configuration (规则与事件管理)

- **排班配置区**：动态表单配置循环周期和强闹钟
- **纪念日管理区**：配置按年循环的日期、通知时间和提醒等级

### Tab 4 - Settings (设置与探针)

- 节假日手动/自动同步触发器
- 目标 App 白名单库（PackageManager 扫描读取与维护）
- 数据备份与恢复入口 (导出/导入本地 JSON 数据)

---

## 六、工程化与进阶生产特性 (上线必读)

### 6.1 纯本地数据防丢：备份与恢复机制

作为纯本地日记/手账类应用，用户换机或卸载会导致致命的数据丢失。必须实现：

#### 本地文件导出
- 将 Room 数据库内容打包为 JSON / ZIP
- 利用 **Android Storage Access Framework (SAF)** 存入用户手机公有目录（如 Documents/）

#### (可选进阶) WebDAV 同步
- 支持用户填入坚果云/阿里云盘的 WebDAV 账号
- 应用定期将备份包静默上传到用户的私人网盘中

---

### 6.2 敏感权限请求引导流 (Permission UX)

现代 Android (特别是 13 和 14) 对后台行为极其严苛。必须设计专门的前置引导 UI：

#### 权限引导流程
1. 首次配置"强闹钟 (Level 2)"时，弹出半屏卡片说明："为了确保锁屏下准时唤醒，我们需要以下权限..."
2. 引导用户开启：
   - `SCHEDULE_EXACT_ALARM`（精准闹钟）
   - `SYSTEM_ALERT_WINDOW`（悬浮窗）
   - 去系统电池设置中关闭应用的"电池优化" (白名单)
3. **优雅降级**：若用户拒绝权限，需有优雅的降级机制（如自动降级为 Level 1 系统通知）

---

### 6.3 开机与时区变更的防断链自愈 (Self-Healing)

#### 问题背景
系统重启后，AlarmManager 注册的所有闹钟都会被系统自动清空。

#### 解决方案
1. **注册系统广播**：
   - 在 `AndroidManifest.xml` 中注册监听：
     - `android.intent.action.BOOT_COMPLETED` (开机完成)
     - `android.intent.action.TIME_SET` (时区变更)

2. **自愈逻辑**：
   - 接收到广播后，拉起后台轻量级 `CoroutineWorker`
   - 重新查询 TaskRecord 表中未执行的任务
   - 重新向系统注册所有闹钟，确保倒班提醒的绝对可靠

---

## 七、技术实现要点总结

### 核心难点
1. ✅ **分级提醒引擎**：Level 0/1/2 的差异化调度与呈现
2. ✅ **防杀后台机制**：Foreground Service + Full-Screen Intent
3. ✅ **动态排班算法**：模运算 + JSON 配置表
4. ✅ **开机自愈**：BOOT_COMPLETED 广播监听与闹钟重建
5. ✅ **权限引导**：精准闹钟、悬浮窗、电池优化的用户引导

### 关键技术点
- Room Database 的响应式查询（Flow）
- Jetpack Compose 的声明式 UI 构建
- AlarmManager 的精准调度与 Doze 模式突破
- Deep Link 唤起第三方应用
- Serverless 静态资源配置同步

---

## 八、当前实现进度与 TODO Roadmap

### 8.1 已完成的核心能力（可运行 Demo）

- **底层架构与基础设施**
  - 已落地：MVVM + Repository 架构、Room 数据库 (`ShiftRule` / `Anniversary` / `TaskRecord` / `Post` / `Holiday` 五张表)、`AppRepository` 统一数据访问层。
  - 已落地：`MainActivity` + `MainScreen` + 4 个 Tab 的导航骨架（Calendar / Feed / Config / Settings）。
- **排班与任务引擎**
  - 已落地：`ShiftSchedulerService` 基于模运算的动态排班算法，可按 `ShiftRule` 生成未来 N 天的 `TaskRecord`，支持 `skipHoliday` 读取 Holiday 表。
  - 已落地：`MainViewModel` 内部集成排班引擎，启动时自动生成测试排班规则与任务实例。
  - 已落地：`taskRecordsByDate` 聚合逻辑，为日历红点/标记提供按天的提醒等级数据。
- **闹钟调度与前台服务**
  - 已落地：`AlarmManagerService`，支持根据 `reminder_level` 为 `TaskRecord` 注册 Alarm（Level 2 使用 `setAlarmClock`，Level 1 使用 `setExact[AndAllowWhileIdle]`）。
  - 已落地：`AlarmService` + `AlarmForegroundService` + `AlarmActivity`，完成强提醒前台服务 + 全屏界面 + 铃声/震动播放与关闭逻辑。
  - 已落地：`AlarmReceiver` 根据任务等级选择启动前台闹钟或发送普通通知。
- **开机/时间变更自愈**
  - 已落地：`BootReceiver` 监听开机、应用更新、时间/时区变化，触发重新生成未来 30 天任务并重新注册所有 pending 闹钟。
- **日历视图**
  - 已落地：`CalendarView` 自定义日历组件 + `CalendarScreen`，可展示每天的提醒强度（强/弱/无），并列出选中日期对应的任务列表。

> 结论：技术核心（调度引擎、闹钟体系、日历展示、自愈机制）已具备“可运行 Demo”的完整链路。

### 8.2 尚未完成 / 仅有骨架的业务功能

以下内容在本方案中已有设计（见 3.x / 5.x / 6.x 等章节），但当前代码仅停留在骨架或尚未实现阶段：

- **Feed 信息流闭环（Tab 2 - 沉淀）**
  - 现状：
    - `FeedScreen` 仅为占位文案“这是沉淀页面”，尚未接入 `Post` / `TaskRecord` 实体。
    - 文档中“任务完成记录与手账内容结合的信息流闭环”尚未落地。
  - 待实现：
    - 基于 `Post` + `TaskRecord` 的联合查询，构建倒序时间线信息流列表（LazyColumn）。
    - 实现图文手账编辑/查看界面，将 `Post.linked_task_ids` 与已完成任务关联。

- **规则与纪念日配置 UI（Tab 3 - Config）**
  - 现状：
    - `ConfigScreen` 仅为占位文案“这是配置页面”，无任何增删改查 UI。
    - 目前排班规则与纪念日数据由 `MainViewModel.initializeTestData` / `createTestShiftRule` 的硬编码测试数据提供。
  - 待实现：
    - ShiftRule 配置 UI：列表 + 新增/编辑/删除表单，可视化配置周期天数、每日多个时间点、是否跳过节假日、默认提醒等级、`targetPkgName` 等。
    - Anniversary 管理 UI：纪念日列表 + 新建/编辑/删除表单，并接入任务生成逻辑。
    - 逐步移除测试数据初始化，让日历与闹钟完全由 Config 页的真实用户配置驱动。

- **设置与探针（Tab 4 - Settings）**
  - 现状：
    - `SettingsScreen` 仅为占位文案“这是设置页面”，缺少文档 5.x / 6.x 中描述的实际入口和配置项。
  - 待实现：
    - 节假日同步入口：手动同步按钮、自动同步开关、同步状态展示。
    - 目标 App 白名单管理：通过 `PackageManager` 扫描已安装应用，支持选择/移除白名单，并与规则/任务的 `targetPkgName` 绑定。
    - 数据备份与恢复入口：本地导出/导入（JSON/ZIP），后续扩展 WebDAV。
    - 权限引导页/卡片：集中引导 `SCHEDULE_EXACT_ALARM`、`POST_NOTIFICATIONS`、`SYSTEM_ALERT_WINDOW`、电池优化白名单等。

- **节假日 Serverless 同步实现**
  - 现状：
    - `Holiday` 实体与 `HolidayDao` 已存在，`ShiftSchedulerService` 也支持根据 Holiday 表跳过节假日。
    - 尚未实现任何 OkHttp/Retrofit 代码，也没有拉取 `holidays_{year}.json` 并写入表的逻辑。
  - 待实现：
    - 节假日获取：基于 Retrofit/OkHttp 从 Serverless/静态托管地址拉取 `holidays_{year}.json`。
    - 数据入库：解析 JSON 后对 `Holiday` 表做 Upsert，支持多年份与增量更新。
    - 触发策略：与 Settings 中的手动按钮 + 自动周期（如每月/跨年）联动。

- **权限引导流与优雅降级**
  - 现状：
    - Manifest 中声明了精确闹钟、前台服务、通知、QUERY_ALL_PACKAGES 等权限。
    - 代码中尚未实现专门的权限引导 UI，也未实现对拒绝场景的降级策略。
  - 待实现：
    - 权限引导组件：半屏卡片/单独页面，按场景引导用户依次开启相关权限，并给出清晰说明。
    - 设置跳转：封装跳转到系统权限/电池设置页的逻辑。
    - 降级策略：当核心权限未授予时，自动降级为弱提醒/仅日历标记等模式。

- **备份与恢复（本地 / WebDAV）**
  - 现状：
    - 文档 6.1 已给出方案，但代码中尚未出现 SAF / 文件 IO / JSON 导入导出的实现。
  - 待实现：
    - 本地备份与恢复：使用 SAF 选择目录/文件；导出 Room 数据为 JSON/ZIP；导入时处理版本兼容与数据合并策略。
    - WebDAV 支持（可选进阶）：配置 WebDAV 账号，定期/手动上传备份包。

- **第三方应用白名单与 Deep Link 配置 UI**
  - 现状：
    - `AlarmActivity` 根据 `targetPkgName` 打开目标 App 或应用市场，但缺少用户配置/绑定该字段的 UI。
  - 待实现：
    - 探针 + 白名单管理：扫描已安装应用，允许用户选中并持久化为“可绑定目标 App”列表。
    - 规则/任务绑定：在 ShiftRule/Task 编辑时选择目标 App，将 `targetPkgName` 写入数据库。

- **任务状态流转与业务闭环**
  - 现状：
    - `TaskRecord.status` 字段已存在，但触发闹钟、关闭或完成操作后，尚未有完善的状态更新与 UI 展示。
  - 待实现：
    - 在闹钟关闭/完成时更新 `TaskRecord.status`（pending → completed/cancelled）。
    - 在 Calendar/Feed 中区分已完成/未完成/过期任务，形成“调度 → 执行 → 沉淀”的完整闭环。

### 8.3 分阶段开发建议（迭代顺序）

为尽快从“技术 Demo”走向“可用产品”，建议按以下优先级推进实现：

1. **第一阶段：可配置可运行**
   - 完成 Config 页的 ShiftRule / Anniversary 配置 UI。
   - 去除对 `MainViewModel` 测试数据的依赖，让用户可以通过 UI 完整配置排班与纪念日并看到日历/闹钟生效。
2. **第二阶段：沉淀与信息流闭环**
   - 完成 Feed 信息流（Post + TaskRecord 联动）以及基础图文手账编辑功能。
   - 同步完善 TaskRecord 的状态流转（已完成/跳过）。
3. **第三阶段：工程化与长线能力**
   - 落地节假日 Serverless 同步、备份/恢复、权限引导流和目标 App 白名单。
   - 完成 Settings Tab 的全部入口，实现真正“长期可依赖”的本地效率工具。

> 当前整体完成度评估：**技术核心约 70%（含调度 / DB / 闹钟 / 自愈），产品功能约 40%**。  
> 本章节将作为后续开发与验收的基准，用于跟踪从 Demo 向可交付版本演进的进度。

---

## 附录：相关技术文档

- [Android AlarmManager 官方文档](https://developer.android.com/reference/android/app/AlarmManager)
- [Jetpack Compose 官方文档](https://developer.android.com/jetpack/compose)
- [Room Database 官方文档](https://developer.android.com/training/data-storage/room)
- [Android 后台限制指南](https://developer.android.com/about/versions/oreo/background)

---

**文档版本**：v1.0  
**最后更新**：2024

