# 如何查看报错日志并找出原因

## 📋 查看日志的方法

### 方法1：在应用内查看（最简单，推荐）

1. **打开应用**
2. **点击底部导航栏的"设置"**（最右边的图标）
3. **点击"查看日志"卡片**
4. 在日志查看器中：
   - **应用日志** 标签页：查看所有应用日志（包括崩溃前的日志）
   - **崩溃报告** 标签页：查看详细的崩溃报告（如果有崩溃发生）

### 方法2：检查 Downloads 文件夹（推荐，最简单）

#### 2.1 手动导出日志

应用提供了便捷的导出功能，可以将所有日志和崩溃报告导出到 Downloads 文件夹：

**操作步骤：**
1. 打开应用
2. 点击底部导航栏的"设置"（最右边的图标）
3. 点击"导出日志到 Downloads"卡片
4. 导出成功后，会显示 Toast 提示，告知文件路径
5. 打开文件管理器，导航到以下路径：
   - **Android/data/com.handnote.app/files/Download/**
   - 或者：**内部存储/Android/data/com.handnote.app/files/Download/**
6. 查找以 `HandNote_log_` 或 `HandNote_crash_` 开头的 `.txt` 文件
7. 打开文件查看日志详情

**注意：** 文件保存在应用特定的 Downloads 目录，无需存储权限。应用卸载时这些文件会被自动删除。

**文件命名格式：**
- 日志文件：`HandNote_log_YYYY-MM-DD_HH-mm-ss.txt`（包含所有日志文件，已合并）
- 崩溃报告：`HandNote_crash_YYYY-MM-DD_HH-mm-ss.txt`

**注意：** 导出的日志文件会将所有日志文件（最多10个）合并到一个文件中，按时间顺序排列，方便完整查看所有日志记录。

#### 2.2 自动导出（崩溃时）

当应用崩溃时，日志和崩溃报告会自动保存到 Downloads 文件夹，无需手动操作。

**查看步骤：**
1. 打开文件管理器
2. 导航到 **Android/data/com.handnote.app/files/Download/** 目录
3. 查找以 `HandNote_crash_` 或 `HandNote_log_` 开头的 `.txt` 文件
4. 打开文件查看崩溃详情

### 方法3：使用 ADB 命令（需要连接设备）

如果已安装 Android SDK Platform Tools 并配置了 ADB：

```bash
# 查看崩溃报告
adb shell run-as com.handnote.app cat files/crash_report.txt

# 查看今天的日志文件
adb shell run-as com.handnote.app cat files/logs/app_$(date +%Y-%m-%d).log

# 列出所有日志文件
adb shell run-as com.handnote.app ls -la files/logs/

# 查看 Downloads 文件夹中的崩溃日志
adb shell ls /sdcard/Download/HandNote_crash_*.txt
```

或者运行项目根目录下的脚本：
```bash
./查看日志并分析错误.sh
```

---

## 🔍 常见错误类型及原因分析

### 1. IllegalStateException（状态异常）

**常见原因：**
- 数据库未正确初始化
- Repository 初始化失败
- ViewModel 初始化失败
- 对象状态不符合预期

**检查点：**
- 查看日志中是否有 "Database initialization failed"
- 查看日志中是否有 "Repository initialization failed"
- 检查 MainActivity.onCreate 中的初始化步骤

**可能的问题代码位置：**
- `MainActivity.kt` 第 108-115 行：数据库初始化
- `MainActivity.kt` 第 122-136 行：Repository 初始化
- `MainViewModel.kt`：ViewModel 初始化

### 2. NullPointerException（空指针异常）

**常见原因：**
- 对象未初始化就使用
- 空值未检查
- 数据库查询返回 null

**检查点：**
- 查看堆栈跟踪，找到空指针发生的位置
- 检查是否有对象在使用前未初始化

**可能的问题代码位置：**
- ViewModel 中的 StateFlow 初始化
- Repository 中的 DAO 访问
- UI 组件中的状态访问

### 3. SQLiteException（数据库异常）

**常见原因：**
- 数据库文件损坏
- 数据库版本不兼容
- SQL 语句错误
- 数据库迁移失败

**检查点：**
- 查看日志中是否有数据库相关的错误信息
- 检查数据库版本号
- 检查数据库迁移脚本

**可能的问题代码位置：**
- `AppDatabase.kt`：数据库定义和迁移
- Repository 中的数据库操作

### 4. FileNotFoundException（文件未找到）

**常见原因：**
- 日志文件路径错误
- 存储权限未授予（Android 10+）
- Downloads 文件夹不存在

**检查点：**
- 检查 AndroidManifest.xml 中的权限声明
- 检查存储权限是否已授予
- 查看日志中是否有权限相关的错误

**解决方案：**
- 确保已添加存储权限（已在 AndroidManifest.xml 中添加）
- 在 Android 10+ 上，确保应用有存储权限

### 5. 应用启动时崩溃

**常见原因：**
- MainActivity.onCreate 中初始化失败
- 数据库初始化失败
- Repository 初始化失败
- UI 组件初始化失败

**检查步骤：**
1. 查看崩溃报告，找到崩溃时的堆栈跟踪
2. 查看应用日志，找到最后几条日志，确定崩溃发生在哪个步骤
3. 检查 MainActivity.onCreate 中的初始化顺序

**MainActivity 初始化顺序：**
1. FileLogger 初始化（第 48-54 行）
2. 设置全局异常处理器（第 56-98 行）
3. 数据库初始化（第 108-115 行）
4. Repository 初始化（第 122-136 行）
5. UI 设置（第 179-190 行）

---

## 📊 日志格式说明

### 应用日志格式

```
[2024-01-15 10:30:45.123] [DEBUG] [MainActivity] MainActivity.onCreate started
[2024-01-15 10:30:45.456] [INFO] [MainActivity] Database initialized successfully
[2024-01-15 10:30:45.789] [ERROR] [MainActivity] Failed to initialize app
java.lang.IllegalStateException: ...
    at ...
```

### 崩溃报告格式

```
========================================
CRASH REPORT
========================================
Timestamp: 2024-01-15 10:30:45.789
Exception: java.lang.IllegalStateException
Message: Database initialization failed

Stack Trace:
java.lang.IllegalStateException: Database initialization failed
    at com.handnote.app.MainActivity.onCreate(MainActivity.kt:114)
    ...
========================================
```

---

## 🛠️ 调试建议

### 如果应用崩溃：

1. **查看崩溃报告**
   - 在应用内打开日志查看器，查看"崩溃报告"标签页
   - 或检查 Downloads 文件夹中的崩溃日志文件

2. **查看启动日志**
   - 查看"应用日志"标签页
   - 找到最后几条日志，确定崩溃发生在哪个步骤

3. **常见崩溃原因检查清单：**
   - [ ] 数据库初始化是否成功？
   - [ ] Repository 初始化是否成功？
   - [ ] ViewModel 初始化是否成功？
   - [ ] UI 组件初始化是否成功？
   - [ ] 权限是否已授予？
   - [ ] 存储空间是否充足？

### 如果应用能启动但功能异常：

1. **查看应用日志**
   - 查找 ERROR 和 WARN 级别的日志
   - 查看错误发生时的上下文信息

2. **检查特定功能**
   - 如果某个功能不工作，查看相关的日志
   - 检查是否有异常被捕获但未处理

---

## 📝 日志文件位置

### 应用内部存储（需要 root 或 ADB）

- **崩溃报告**：`/data/data/com.handnote.app/files/crash_report.txt`
- **应用日志**：`/data/data/com.handnote.app/files/logs/app_YYYY-MM-DD.log`

### 外部存储（可直接访问）

- **日志文件**：`/sdcard/Download/HandNote_log_YYYY-MM-DD_HH-mm-ss.txt`
- **崩溃报告**：`/sdcard/Download/HandNote_crash_YYYY-MM-DD_HH-mm-ss.txt`

**注意：** 日志文件包含所有应用日志（包括崩溃前的日志），崩溃报告只包含崩溃时的详细信息。

---

## 🔧 如果无法查看日志

如果应用无法启动，无法在应用内查看日志：

1. **使用 ADB**（如果可用）
   ```bash
   adb shell run-as com.handnote.app cat files/crash_report.txt
   ```

2. **检查 Downloads 文件夹**
   - 崩溃日志会自动保存到 Downloads 文件夹
   - 即使应用无法启动，崩溃日志也会被保存

3. **查看 Logcat**
   - 使用 Android Studio 的 Logcat 工具
   - 过滤标签：`MainActivity`、`FileLogger`

---

## 💡 提示

- 日志文件会自动清理，最多保留 10 个日志文件
- 单个日志文件最大 5MB，超过后会自动创建新文件
- **崩溃时自动导出**：应用崩溃时，日志和崩溃报告会自动导出到 Downloads 文件夹
- **手动导出**：可以在设置页面点击"导出日志到 Downloads"按钮，随时导出日志
- 导出的日志文件包含所有应用日志（包括崩溃前的日志），方便完整分析问题
- 建议定期查看日志，及时发现问题
- 如果应用无法启动，崩溃日志仍会自动保存到 Downloads 文件夹，可以直接查看

